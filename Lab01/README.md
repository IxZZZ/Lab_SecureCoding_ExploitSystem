
# **Lab 01 Automating Everything As Code**

## Automating

### Bài 5: Dùng Jenkins để kiểm tra bản dựng

Trong phần này ta sẽ tạo job thứ 2, kiểm tra bản dựng hoạt động bình thường. 
- Bước 1: Tạo job mới để kiểm tra `sample-app`, đặt tên: `TestAppJob_HoXuanNinh`
- Bước 2: Cấu hình Jenkins TestAppJob :

  B1. Đặt description: `My first HoXuanninh's Jenkins test` 
  
  B2. Source Code Management chọn None 
  
  B3. Ở Build  Triggers  tab,  chọn checkbox `Build  after  other  projects  are  built`  và điền `BuildAppJob` 
  
- Bước 3: Viết tập lệnh thử nghiệm sẽ chạy sau khi dựng BuildAppJob:

  B1. Chọn Build tab 

  B2. Chọn Add build step và chọn Execute shell

    ```bash
      docker ps | grep sampleapp | awk 'END {if ($1 != "") exit 0; exit 1;}
    ```
    
    B3. Chọn Save 

- Bước 4: Yêu cầu Jenkins chạy lại job BuildAppJob 

- Bước 5: Kiểm tra cả 2 job hoàn thành hay không

  Khi chạy thành công: 
    ![image](https://user-images.githubusercontent.com/31529599/135873990-d5f34513-9f55-44e4-b787-934076a97276.png)
    
    Console output của Job BuildAppJob:
    
    ![image](https://user-images.githubusercontent.com/31529599/135874180-7ca9646e-2065-4381-b8e4-c1d7d5482ff6.png)
    
    Console output của Job TestAppJob:
    
    ![image](https://user-images.githubusercontent.com/31529599/135874478-5a9788c2-9ec1-44f9-a3d0-bc64fd76dea3.png)
 
  Khi Stop docker app và build Job TestAppJob:
    
    ![image](https://user-images.githubusercontent.com/31529599/135874937-23627249-5dcf-4289-96b5-b732f3a5ffc4.png)

### Bài 6: Tạo pipeline trong Jenkins

- Bước 1: Tạo job Pipeline 

  B1. Chọn New Item 

  B2. Ở trường Enter an item name, điền SamplePipelineTênNhóm 

  B3. Chọn kiểu job Pipeline 

  B4. Chọn OK 

- Bước 2: Cấu hình job SamplePipeline 
      Ở tab Build trigger, trong phần Pipeline section điền đoạn mã sau
  ```bash
    node { 
    stage('Preparation') { 
        catchError(buildResult: 'SUCCESS') { 
            sh 'docker stop samplerunning' 
            sh 'docker rm samplerunning' 
        } 
    } 
    stage('Build') { 
        build 'BuildAppjob' 
    } 
    stage('Results') { 
        build 'TestAppJob_HoXuanNinh' 
    } 
  }
  ```

 Giải thích:
 
 Tạo pipeline ở bên trong một `node`, sẽ lần lượt thực hiện các `stage` ở bên trong `node`:
 - Ở stage đầu tiên sẽ dừng container của ứng dụng `sampleapp` đã chạy và xóa container đã được build trước đó, đồng thời `catcherror` nếu các lệnh xảy ra lỗi nghĩa là container `sampleapp` chưa được build và chạy. 
 - Ở stage thứ hai, build job `BuildAppjob`
 - Ở stage thứ ba, build job `TestAppJob_HoXuanNinh`
 
  
 Kết quả:

![image](https://user-images.githubusercontent.com/31529599/135876798-53412384-e3d0-4b0d-8706-14ef5c4a3718.png)

### Bài 7 : Sửa lỗi bằng cách duy chuyển `ret_val = []`

Code được sửa lại thành

File `recursive_json_search.py`:

```python
# Fill the Python code in this file
from test_data import *

global ret_val 
ret_val= []

def json_search(key, input_object):
    
    if isinstance(input_object, dict):  # Iterate dictionary
        for k, v in input_object.items():  # searching key in the dict
            if k == key:
                temp = {k: v}
                ret_val.append(temp)
            if isinstance(v, dict):  # the value is another dict so repeat
                json_search(key, v)
            elif isinstance(v, list):  # it's a list
                for item in v:
                    if not isinstance(item,  (str, int)):  # if  dict  orlist repeat
                        json_search(key, item)
    else:  # Iterate a list because some APIs return JSON object in a list
        for val in input_object:
            if not isinstance(val, (str, int)):
                json_search(key, val)

    return ret_val


print(json_search(key1, data))
```

Kết quả chạy `unittest`:

![image](https://user-images.githubusercontent.com/31529599/135890084-d893c115-47a9-44e1-91ab-9cc42b55de9d.png)

  
### Bài 8: Sửa lỗi thực thi unittest
  Giải thích: Vì cách ở bài 7 sài `global variable` nên khi thực hiện nhiều test thì biến `ret_val` đã được cập nhật ở lần gọi trước cho nên khi gọi ở test case 2 khi trả về khác rỗng. Sửa lại bằng cách truyền biến trực tiếp khi gọi hàm để cập nhật biến `ret_val` thay vì sử dụng biến toàn cục.
  Code sửa lại thành
  
File: `recursive_json_search.py`

```python
from test_data import *


def json_search(key, input_object,ret_val):
    
    if isinstance(input_object, dict):  # Iterate dictionary
        for k, v in input_object.items():  # searching key in the dict
            if k == key:
                temp = {k: v}
                ret_val.append(temp)
            if isinstance(v, dict):  # the value is another dict so repeat
                json_search(key, v, ret_val)
            elif isinstance(v, list):  # it's a list
                for item in v:
                    if not isinstance(item,  (str, int)):  # if  dict  orlist repeat
                        json_search(key, item, ret_val)
    else:  # Iterate a list because some APIs return JSON object in a list
        for val in input_object:
            if not isinstance(val, (str, int)):
                json_search(key, val, ret_val)

    return ret_val


print(json_search(key1, data,[]))

```
File `test_json_search.py`:

```python
# Fill the Python code in this file
import unittest

from recursive_json_search import *
from test_data import *


class json_search_test(unittest.TestCase):
    '''test module to test search function in `recursive_json_search.py`'''

    def test_search_found(self):
        '''key should be found, return list should not be empty'''
        self.assertTrue([] != json_search(key1, data,[]))

    def test_search_not_found(self):
        '''key should not be found, should return an empty list'''
        self.assertTrue([] == json_search(key2, data,[]))

    def test_is_a_list(self):
        '''Should return a list'''
        self.assertIsInstance(json_search(key1, data,[]), list)


if __name__ == '__main__':
    unittest.main()

```

Kết quả chạy `unittest`:

![image](https://user-images.githubusercontent.com/31529599/135890205-05e66985-9818-4102-a25a-2bfc693ef991.png)
